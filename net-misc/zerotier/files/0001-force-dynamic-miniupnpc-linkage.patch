From ebdb3b4f6dd71673512e371a8da659c88b348925 Mon Sep 17 00:00:00 2001
From: Kay Shinonome <kayshinonome@protonmail.com>
Date: Tue, 12 Apr 2022 03:38:18 -0500
Subject: [PATCH 1/5] force dynamic miniupnpc linkage

---
 make-linux.mk | 25 +++++++++++++++----------
 1 file changed, 15 insertions(+), 10 deletions(-)

diff --git a/make-linux.mk b/make-linux.mk
index c5daa0b3..50107b7e 100644
--- a/make-linux.mk
+++ b/make-linux.mk
@@ -21,19 +21,24 @@ ONE_OBJS+=osdep/LinuxNetLink.o
 # for central controller buildsk
 TIMESTAMP=$(shell date +"%Y%m%d%H%M")
 
-# Auto-detect miniupnpc and nat-pmp as well and use system libs if present,
-# otherwise build into binary as done on Mac and Windows.
 ONE_OBJS+=osdep/PortMapper.o
-override DEFS+=-DZT_USE_MINIUPNPC
-MINIUPNPC_IS_NEW_ENOUGH=$(shell grep -sqr '.*define.*MINIUPNPC_VERSION.*"2..*"' /usr/include/miniupnpc/miniupnpc.h && echo 1)
-#MINIUPNPC_IS_NEW_ENOUGH=$(shell grep -sqr '.*define.*MINIUPNPC_VERSION.*"2.."' /usr/include/miniupnpc/miniupnpc.h && echo 1)
-ifeq ($(MINIUPNPC_IS_NEW_ENOUGH),1)
+
+# Only use upnp if asked
+# If it isn't new enough then die
+
+ifeq ($(ZT_USE_MINIUPNPC),1)
+	MINIUPNPC_IS_NEW_ENOUGH=$(shell grep -sqr '.*define.*MINIUPNPC_VERSION.*"2..*"' /usr/include/miniupnpc/miniupnpc.h && echo 1)
+	
+	ifeq ($(MINIUPNPC_IS_NEW_ENOUGH),0)
+		echo "Miniupnpc is not new enough"
+		exit 1
+	endif
+
 	override DEFS+=-DZT_USE_SYSTEM_MINIUPNPC
-	LDLIBS+=-lminiupnpc
-else
-	override DEFS+=-DMINIUPNP_STATICLIB -DMINIUPNPC_SET_SOCKET_TIMEOUT -DMINIUPNPC_GET_SRC_ADDR -D_BSD_SOURCE -D_DEFAULT_SOURCE -D_XOPEN_SOURCE=600 -DOS_STRING=\"Linux\" -DMINIUPNPC_VERSION_STRING=\"2.0\" -DUPNP_VERSION_STRING=\"UPnP/1.1\" -DENABLE_STRNATPMPERR
-	ONE_OBJS+=ext/miniupnpc/connecthostport.o ext/miniupnpc/igd_desc_parse.o ext/miniupnpc/minisoap.o ext/miniupnpc/minissdpc.o ext/miniupnpc/miniupnpc.o ext/miniupnpc/miniwget.o ext/miniupnpc/minixml.o ext/miniupnpc/portlistingparse.o ext/miniupnpc/receivedata.o ext/miniupnpc/upnpcommands.o ext/miniupnpc/upnpdev.o ext/miniupnpc/upnperrors.o ext/miniupnpc/upnpreplyparse.o
+	override DEFS+=-DZT_USE_MINIUPNPC
+	LDLIBS+=-lminiupnpc
 endif
+
 ifeq ($(wildcard /usr/include/natpmp.h),)
 	ONE_OBJS+=ext/libnatpmp/natpmp.o ext/libnatpmp/getgateway.o
 else
-- 
2.35.1

